<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Single Table Inheritance in Mongoid &middot; Blog @ RohitRox
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/main.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- init static value -->
  <script type="text/javascript">


	
	var _page = {
		category : 'rails'
	};

	var _site = {
		baseurl : '',
		logo :  ''
	};

	var _nav = {};

	
		_nav['Home'] = '/';
	
		_nav['Categories'] = '/categories/';
	
		_nav['Tags'] = '/tags/';
	
		_nav['About'] = '/about/';
	


  </script>
  
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"> </script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } });
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="sidebar-personal-info">
      
      <div class="sidebar-personal-info-section">
        <h1 class="sidebar-personal-info-name">Rohit Joshi</h1>
      </div>
      <div class="sidebar-personal-info-section">
        <p>Full Stack Software Developer</p>
      </div>
      
      
      
      <div class="sidebar-personal-info-section">
        <p>
          
            
            
            <a href="https://www.linkedin.com/in/rohitrox">
              <i class="fa fa-linkedin" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="https://github.com/rohitrox">
              <i class="fa fa-github" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="https://twitter.com/roxxypoxxy">
              <i class="fa fa-twitter" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="">
              <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
            
            
          
        </p>
      </div>
      
    </div>
  </div>

  <nav class="sidebar-nav">
	
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/">
			  Home
			</a>
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item fold-by-click" href="javascript:;">
			  Categories
			</a>
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#">
				- All
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#ruby">
				- Ruby
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#mysql">
				- MySQL
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#javascript">
				- Javascript
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#devtips">
				- DevTips
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#rails">
				- Rails
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#linux">
				- Linux
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#mongodb">
				- MongoDB
			</a>
			
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/tags/">
			  Tags
			</a>
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/about/">
			  About
			</a>
		
      </span>

    

    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
    Made with <a href="http://jekyllrb.com">jekyll</a> and <a href="http://codinfox.github.io">codinfox-lanyon</a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            
              <a href="/" title="Home" title="Blog @ RohitRox" class="masthead-tagline-link">
                Blog @ RohitRox
              </a>
            
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Single Table Inheritance in Mongoid</h1>
  <span class="post-date">30 Aug 2013</span>
   | 
  
    <a href="/tags/#rails" class="post-tag">rails</a>
  
    <a href="/tags/#mongoid" class="post-tag">mongoid</a>
  
  
  <article>
    <p>Single table inheritance is a software pattern described by Martin Fowler. STI is basically an idea of using a single table(colection in case of mongo) to reflect multiple models that inherit from a base model.</p>

<p>We use STI pattern when we are dealing with classes that have same attributes and behaviour. Rather than duplicate the same code over and over, STI helps us to use a common base model and write specific behaviours in its inherited class while keeeping data on a same table.</p>

<p>Mongoid supports inheritance in both root and embedded documents. In
scenarios where documents are inherited from their fields, relations, validations and scopes get copied down into their child documents, but not vice-versa.</p>

<p>A very simple example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">class</span> <span class="nc">Employee</span>
      <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
      <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span>
      <span class="n">field</span> <span class="ss">:employee_code</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">FullTimeEmployee</span> <span class="o">&lt;</span> <span class="no">Employee</span>
      <span class="n">field</span> <span class="n">status</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">"Temporary"</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">InternEmployee</span> <span class="o">&lt;</span> <span class="no">Employee</span>
      <span class="n">field</span> <span class="n">intern_period</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
    <span class="k">end</span>


</code></pre></div></div>

<!-- more -->

<p>In the above example, both FullTimeEmployee and InternEmployee will be saved in the Employee collection. An additional attribute _type is automatically stored in order to make sure when loaded from the database the correct document is returned.</p>

<p>Following behaviour can be seen, much similar to Single Table Inheritance in ActiveRecord.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="n">emp1</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">emp2</span> <span class="o">=</span> <span class="no">FullTimeEmployee</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">emp3</span> <span class="o">=</span> <span class="no">InternEmployee</span><span class="p">.</span><span class="nf">new</span>

  <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span>
  <span class="c1">#=&gt; 3</span>
  <span class="no">FullTimeEmployee</span><span class="p">.</span><span class="nf">count</span>
  <span class="c1">#=&gt; 1</span>
  <span class="no">InternEmployee</span><span class="p">.</span><span class="nf">count</span>
  <span class="c1">#=&gt; 1</span>
  <span class="n">emp1</span><span class="p">.</span><span class="nf">_type</span>
  <span class="c1">#=&gt; "Employee"</span>
  <span class="n">emp2</span><span class="p">.</span><span class="nf">_type</span>
  <span class="c1">#=&gt; "FullTimeEmployee"</span>
  <span class="n">emp3</span><span class="p">.</span><span class="nf">_type</span>
  <span class="c1">#=&gt; "InternEmployee"</span>

  <span class="no">Employee</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"..."</span><span class="p">)</span>
  <span class="c1">#=&gt; Returns Employee documents and subclasses</span>
  <span class="no">FullTimeEmployee</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"..."</span><span class="p">)</span>
  <span class="c1">#=&gt; returns only FullTimeEmployee documents</span>


</code></pre></div></div>

<p>An advance example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">class</span> <span class="nc">Canvas</span>
      <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
      <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span>
      <span class="n">embeds_many</span> <span class="ss">:shapes</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Browser</span> <span class="o">&lt;</span> <span class="no">Canvas</span>
      <span class="n">field</span> <span class="ss">:version</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
      <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">:version</span><span class="p">.</span><span class="nf">gt</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Firefox</span> <span class="o">&lt;</span> <span class="no">Browser</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Shape</span>
      <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
      <span class="n">field</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
      <span class="n">field</span> <span class="ss">:y</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
      <span class="n">embedded_in</span> <span class="ss">:canvas</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Circle</span> <span class="o">&lt;</span> <span class="no">Shape</span>
      <span class="n">field</span> <span class="ss">:radius</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Float</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Rectangle</span> <span class="o">&lt;</span> <span class="no">Shape</span>
      <span class="n">field</span> <span class="ss">:width</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Float</span>
      <span class="n">field</span> <span class="ss">:height</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Float</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>Canvas, Browser and Firefox will all save in the canvases collection.This also holds true for the embedded documents Circle, Rectangle, and Shape.</p>

<p>To query for subclasses within an embedded collection you need to leverage the _type attribute in each subclassed object. Canvas and Shape documents, would not have it, but Browser, Firefox, Circle, and Rectangle would. Keep in mind that _type is a string that stores the name of the document’s class, and as such can only be used to query for a specific subclass, and not anything it is a subclass of.</p>

<p>If, for example, Rectangle was a subclass of Parallelogram which was in turn a subclass of Shape, you could search the Canvas’s shapes collection for objects with a _type of “Parallelogram” but it would never return a Rectangle object, and vice-versa.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="c1"># Returns all the Rectangle shapes in a previously found Canvas</span>
  <span class="n">my_canvas</span><span class="p">.</span><span class="nf">shapes</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">_type: </span><span class="s2">"Rectangle"</span><span class="p">)</span>

  <span class="c1"># Returns no entries (see above)</span>
  <span class="n">my_canvas</span><span class="p">.</span><span class="nf">shapes</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">_type: </span><span class="s2">"Shape"</span><span class="p">)</span>

  <span class="c1"># Returns all the Canvasas that have Circles</span>
  <span class="no">Canvas</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"shapes._type"</span><span class="o">=&gt;</span><span class="s2">"Circle"</span><span class="p">)</span>

  <span class="c1"># Returns no entries (see above)</span>
  <span class="no">Canvas</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"shapes._type'=&gt;"</span><span class="no">Shape</span><span class="s2">")
</span></code></pre></div></div>

  </article>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/06/23/rails-api-backed-with-jwt/">
            Rails api backed with jwt
            <small>23 Jun 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/12/06/embercli-and-rails-and-beyond/">
            Ember Cli and Rails And Beyond
            <small>06 Dec 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/03/16/emberjs-and-highcharts/">
            Emberjs and Highcharts
            <small>16 Mar 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


<div class="comments">
  <h2>Comments</h2>
  <div id="disqus_thread"></div>
  <script>
var disqus_config = function () {
  this.page.url = 'http://rohitrox.github.io/2013/08/30/single-table-inheritance-in-mongoid/'; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = '/2013/08/30/single-table-inheritance-in-mongoid'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = '//webdevelopmentlog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
var foldableEvent = {
	'click' : function(target){
		if (target.className.indexOf('fold-by-click') == -1)
		{
			return;
		}

		var subMenu = target.parentElement.querySelectorAll('a.sidebar-nav-item-sub');
		if (subMenu.length < 1)
		{
			return;
		}

		var display = subMenu[0].style.display;
		subMenu.forEach(function(elem, index){
			elem.style.display = (display != 'none')? 'none' : '';
		});
	}
};

var activeEvent = {
	'click' : function(target){
		if (!target.classList.contains('sidebar-nav-item'))
		{
			return;
		}

		document.querySelectorAll('a.sidebar-nav-item').forEach(function(elem,index){
			elem.classList.remove('active');
		});

		target.classList.add('active');
	}
};

var context = decodeURIComponent(document.URL.replace(/^((http|https):\/\/[A-Za-z0-9.:]*\/)/g, '/')).replace(/\s/g, '-');

document.querySelectorAll('a.sidebar-nav-item').forEach(function(elem,index){
	var href = elem.getAttribute('href');
	var href1 = href.replace('/[a-zA-Z]/g','A');
	var categoryUrl = '/' + _page.category.toLowerCase();
	var menuUrl = _site.baseurl + _nav.Categories + '#' + _page.category.toLowerCase();
	if (context == href || (context != '/' && context.startsWith(categoryUrl) && menuUrl == href))
	{
		elem.classList.add('active');
	}
});

(function(document) {
	var toggle = document.querySelector('.sidebar-toggle');
	var sidebar = document.querySelector('#sidebar');
	var checkbox = document.querySelector('#sidebar-checkbox');

	document.addEventListener('click', function(e) {
	  var target = e.target;

	  if (target === toggle) {
		checkbox.checked = !checkbox.checked;
		e.preventDefault();
	  } else if (checkbox.checked && !sidebar.contains(target)) {
		checkbox.checked = false;
	  }

	  foldableEvent.click(target);
	  activeEvent.click(target);
	}, false);
})(document);

</script>


    
  </body>
  
  <script id="dsq-count-scr" src="//webdevelopmentlog.disqus.com/count.js" async></script>
  
  
</html>
