<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Blog &middot; Blog @ RohitRox
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/main.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- init static value -->
  <script type="text/javascript">


	
	var _page = {
		category : 'null'
	};

	var _site = {
		baseurl : '',
		logo :  ''
	};

	var _nav = {};

	
		_nav['Home'] = '/';
	
		_nav['Categories'] = '/categories/';
	
		_nav['Tags'] = '/tags/';
	
		_nav['About'] = '/about/';
	


  </script>
  
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"> </script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } });
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="sidebar-personal-info">
      
      <div class="sidebar-personal-info-section">
        <h1 class="sidebar-personal-info-name">Rohit Joshi</h1>
      </div>
      <div class="sidebar-personal-info-section">
        <p>Full Stack Software Developer</p>
      </div>
      
      
      
      <div class="sidebar-personal-info-section">
        <p>
          
            
            
            <a href="https://www.linkedin.com/in/rohitrox">
              <i class="fa fa-linkedin" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="https://github.com/rohitrox">
              <i class="fa fa-github" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="https://twitter.com/roxxypoxxy">
              <i class="fa fa-twitter" aria-hidden="true"></i>
            </a>
            
            |
          
            
            
            <a href="">
              <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
            
            
          
        </p>
      </div>
      
    </div>
  </div>

  <nav class="sidebar-nav">
	
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/">
			  Home
			</a>
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item fold-by-click" href="javascript:;">
			  Categories
			</a>
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#">
				- All
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#ruby">
				- Ruby
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#mysql">
				- MySQL
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#javascript">
				- Javascript
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#devtips">
				- DevTips
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#rails">
				- Rails
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#linux">
				- Linux
			</a>
			
			
			<a class="sidebar-nav-item sidebar-nav-item-sub" href="/categories/#mongodb">
				- MongoDB
			</a>
			
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/tags/">
			  Tags
			</a>
		
      </span>

    
      
      
      

      

      <span class="">
        
			<a class="sidebar-nav-item" href="/about/">
			  About
			</a>
		
      </span>

    

    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
    Made with <a href="http://jekyllrb.com">jekyll</a> and <a href="http://codinfox.github.io">codinfox-lanyon</a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            
              <a href="/" title="Home" title="Blog @ RohitRox" class="masthead-tagline-link">
                Blog @ RohitRox
              </a>
            
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
    <div class="post">
      <h1 class="post-title">
        <a href="/2013/08/30/single-table-inheritance-in-mongoid/">
          Single Table Inheritance in Mongoid
        </a>
      </h1>

      <span class="post-date">30 Aug 2013</span>
       |
      
      <a href="/tags/#rails" class="post-tag">rails</a>
      
      <a href="/tags/#mongoid" class="post-tag">mongoid</a>
      
      

      <article>
        <p>Single table inheritance is a software pattern described by Martin Fowler. STI is basically an idea of using a single table(colection in case of mongo) to reflect multiple models that inherit from a base model.</p>

<p>We use STI pattern when we are dealing with classes that have same attributes and behaviour. Rather than duplicate the same code over and over, STI helps us to use a common base model and write specific behaviours in its inherited class while keeeping data on a same table.</p>

<p>Mongoid supports inheritance in both root and embedded documents. In
scenarios where documents are inherited from their fields, relations, validations and scopes get copied down into their child documents, but not vice-versa.</p>

<p>A very simple example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">class</span> <span class="nc">Employee</span>
      <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
      <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span>
      <span class="n">field</span> <span class="ss">:employee_code</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">FullTimeEmployee</span> <span class="o">&lt;</span> <span class="no">Employee</span>
      <span class="n">field</span> <span class="n">status</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">"Temporary"</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">InternEmployee</span> <span class="o">&lt;</span> <span class="no">Employee</span>
      <span class="n">field</span> <span class="n">intern_period</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Integer</span>
    <span class="k">end</span>


</code></pre></div></div>


      <article>
      <div class="post-more">
        
        <a href="/2013/08/30/single-table-inheritance-in-mongoid/#disqus_thread"> <i class="fa fa-comments" aria-hidden="true"></i>Comment</a>&nbsp;
        
        <a href="/2013/08/30/single-table-inheritance-in-mongoid/"><i class="fa fa-plus-circle" aria-hidden="true"></i>Read more</a>
      </div>
    </div>
  
    <div class="post">
      <h1 class="post-title">
        <a href="/2013/08/26/up-and-running-ruby-on-rails-on-ubuntu/">
          Up and running Ruby on Rails on Ubuntu
        </a>
      </h1>

      <span class="post-date">26 Aug 2013</span>
       |
      
      <a href="/tags/#rails" class="post-tag">rails</a>
      
      <a href="/tags/#ubuntu" class="post-tag">ubuntu</a>
      
      

      <article>
        <h3 id="6-steps-for-setting-ruby-on-rails-development-environment-in-ubuntu">6 steps for setting ruby on rails development environment in Ubuntu.</h3>

<h3 id="step-1-setting-up-rvm">Step 1: Setting up RVM</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span><span class="nb">sudo </span>apt-get update
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>curl
    <span class="nv">$ </span>curl <span class="nt">-L</span> https://get.rvm.io | bash <span class="nt">-s</span> stable
    <span class="nv">$ </span><span class="nb">source</span> ~/.rvm/scripts/rvm
</code></pre></div></div>

<p>In order to work, RVM has some of its own dependancies that need to be installed. You can see what these are:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span>rvm requirements
    <span class="c"># In the text that RVM shows you, look for this paragraph.</span>
    <span class="c"># Additional Dependencies:</span>
    <span class="c"># For ruby:</span>
    <span class="c"># apt-get --no-install-recommends install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev  libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev libgdbm-dev ncurses-dev automake libtool bison subversion pkg-config libffi-dev</span>
    <span class="c"># Just follow the instructions to get your system up to date with all of the required dependancies.</span>
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nt">--no-install-recommends</span> <span class="nb">install </span>build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev libgdbm-dev ncurses-dev automake libtool bison subversion pkg-config libffi-dev
</code></pre></div></div>
<p>Then</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[[ -s "$HOME/.rvm/scripts/rvm" ]] &amp;&amp; source "$HOME/.rvm/scripts/rvm" &gt;&gt; ~/.bash_profile
    # or
    $ echo '</span><span class="o">[[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.rvm/scripts/rvm"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.rvm/scripts/rvm"</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</code></pre></div></div>

<h3 id="step-2-install-ruby">Step 2: Install ruby</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span>rvm <span class="nb">install </span>1.9.3
    <span class="c"># after success you can verify your installation by</span>
    <span class="nv">$ </span>rvm list
    <span class="c"># should output something like</span>
    <span class="c"># rvm rubies</span>
    <span class="c"># =* ruby-1.9.3-p362 [ i686 ]</span>
</code></pre></div></div>

<h3 id="step-3-rubygems">Step 3: RubyGems</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span>rvm rubygems current
</code></pre></div></div>

<h3 id="step-4-rails">Step 4: Rails</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># a Javascript runtime, NodeJs</span>
    <span class="nv">$ </span><span class="nb">sudo </span>add-apt-repository ppa:chris-lea/node.js
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get update
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>nodejs

    <span class="nv">$ </span>gem <span class="nb">install </span>bundler
    <span class="nv">$ </span>gem <span class="nb">install </span>rails
</code></pre></div></div>

<h3 id="step-5-first-rails-app">Step 5: First Rails app</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ rails new my_app
    $ cd my_app
    $ bundle install
    $ rails s
    # open browser and visit localhost:3000
    # you should see the famous welcome abroad page
</code></pre></div></div>
<h3 id="step-6-development-extras">Step 6: Development Extras</h3>

<h4 id="sublime-text-2">Sublime Text 2</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span><span class="nb">sudo </span>add-apt-repository ppa:webupd8team/sublime-text-2
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get update
    <span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>sublime-text
</code></pre></div></div>
<p>Install sublime package manager from <a href="http://wbond.net/sublime_packages/package_control/installation">here</a> for other sublime goodies.</p>

<h4 id="configure-vim-for-rails">Configure Vim for Rails</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span>curl <span class="nt">-Lo-</span> https://bit.ly/janus-bootstrap | bash
</code></pre></div></div>

      <article>
      <div class="post-more">
        
        <a href="/2013/08/26/up-and-running-ruby-on-rails-on-ubuntu/#disqus_thread"> <i class="fa fa-comments" aria-hidden="true"></i>Comment</a>&nbsp;
        
        <a href="/2013/08/26/up-and-running-ruby-on-rails-on-ubuntu/"><i class="fa fa-plus-circle" aria-hidden="true"></i>Read more</a>
      </div>
    </div>
  
    <div class="post">
      <h1 class="post-title">
        <a href="/2013/08/23/get-selected-text-from-webpage/">
          Get Selected text from Web Page
        </a>
      </h1>

      <span class="post-date">23 Aug 2013</span>
       |
      
      <a href="/tags/#javascript" class="post-tag">javascript</a>
      
      <a href="/tags/#jquery" class="post-tag">jquery</a>
      
      

      <article>
        <p>This is a quick tip you can use for getting the selected text from your webpage.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;p&gt;</span>I am not selectable. You can test.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"here"</span><span class="nt">&gt;</span>
        How about selecting me. Try me.
    <span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="kd">function</span> <span class="nx">getSelectedText</span><span class="p">(){</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">text</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">().</span><span class="nx">text</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">'#here'</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"mouseup"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">getSelectedText</span><span class="p">());</span>
        <span class="p">});</span>

    <span class="p">});</span>
</code></pre></div></div>

      <article>
      <div class="post-more">
        
        <a href="/2013/08/23/get-selected-text-from-webpage/#disqus_thread"> <i class="fa fa-comments" aria-hidden="true"></i>Comment</a>&nbsp;
        
        <a href="/2013/08/23/get-selected-text-from-webpage/"><i class="fa fa-plus-circle" aria-hidden="true"></i>Read more</a>
      </div>
    </div>
  
    <div class="post">
      <h1 class="post-title">
        <a href="/2013/08/18/lets-learn-to-knockout/">
          Lets learn to knockout
        </a>
      </h1>

      <span class="post-date">18 Aug 2013</span>
       |
      
      <a href="/tags/#javascript" class="post-tag">javascript</a>
      
      <a href="/tags/#knockoutjs" class="post-tag">knockoutjs</a>
      
      

      <article>
        <p>Knockout.js is known for rapid and responsive UI development. Lets try it to build something today.
Lets see quick <a href="http://rohitrox.github.io/knockoutjs_projects">demo</a> of what we are going to build.</p>

<p><a href="https://github.com/RohitRox/knockoutjs_projects/archive/master.zip">Download Source</a></p>

<p>This is a basic table that is used in bills or receipts. We will try to add some magic to table like autocomplete, automatic information fill up of selected item and calculation of amounts with the help of knockout.</p>

<p>I will not describe what knockout.js is and why use it.
<a href="http://learn.knockoutjs.com">Learn.knockout.js</a> has an excellent
tutorial for knockout js beginners. I strongly suggest to go through
learn.knockoutjs.com before proceeding.</p>

<p>I assume basic understanding of knockout js from here.</p>

<p>Let’s setup the files first. Nothing fancy, I have just used jquery source file and knockout source js from their official websites and I have used twitter bootstrap prettifying stuffs.</p>

<p>I have initial table markup, which looks like as shown below:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
	    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
	      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span12"</span><span class="nt">&gt;</span>
	        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
	          <span class="nt">&lt;thead&gt;</span>
	            <span class="nt">&lt;tr&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Item<span class="nt">&lt;/th&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Description<span class="nt">&lt;/th&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Unit Price<span class="nt">&lt;/th&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Amount<span class="nt">&lt;/th&gt;</span>
	              <span class="nt">&lt;th&gt;</span>Actions<span class="nt">&lt;/th&gt;</span>
	            <span class="nt">&lt;/tr&gt;</span>
	          <span class="nt">&lt;/thead&gt;</span>
	          <span class="nt">&lt;tbody&gt;</span>
	            <span class="nt">&lt;tr&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span3"</span>  <span class="nt">/&gt;&lt;/td&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span4"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
	              <span class="nt">&lt;td&gt;&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Remove<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
	            <span class="nt">&lt;/tr&gt;</span>
	          <span class="nt">&lt;/tbody&gt;</span>
	        <span class="nt">&lt;/table&gt;</span>
	        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"pull-left"</span><span class="nt">&gt;</span>
	          <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Add New Row<span class="nt">&lt;/button&gt;</span>
	          <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
	        <span class="nt">&lt;/p&gt;</span>
	        <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
	          <span class="nt">&lt;strong&gt;</span>Grand Total: <span class="nt">&lt;span&gt;&lt;/span&gt;</span> <span class="nt">&lt;/strong&gt;</span>
	        <span class="nt">&lt;/h4&gt;</span>
	      <span class="nt">&lt;/div&gt;</span>
	    <span class="nt">&lt;/div&gt;</span>
	  <span class="nt">&lt;/div&gt;</span>

</code></pre></div></div>
<p>Lets see what we have upto here and talk something about what we are trying to do to this table.</p>

<p><img src="/assets/images/knockout-table-1.png" alt="knockout table 1" /></p>

<p>Lets summarize the behaviours we would like to have:</p>

<ul>
  <li>Add a new row</li>
  <li>Suggest items in item field</li>
  <li>Fill up the item information (description and price) automatically</li>
  <li>Calculate the grand total as items are added</li>
  <li>A remove button to remove item and re-compute grand total automatically on removal</li>
</ul>


      <article>
      <div class="post-more">
        
        <a href="/2013/08/18/lets-learn-to-knockout/#disqus_thread"> <i class="fa fa-comments" aria-hidden="true"></i>Comment</a>&nbsp;
        
        <a href="/2013/08/18/lets-learn-to-knockout/"><i class="fa fa-plus-circle" aria-hidden="true"></i>Read more</a>
      </div>
    </div>
  
    <div class="post">
      <h1 class="post-title">
        <a href="/2013/07/19/canvas-images-and-rails/">
          Canvas Images and Rails
        </a>
      </h1>

      <span class="post-date">19 Jul 2013</span>
       |
      
      <a href="/tags/#javascript" class="post-tag">javascript</a>
      
      <a href="/tags/#rails" class="post-tag">rails</a>
      
      <a href="/tags/#canvas" class="post-tag">canvas</a>
      
      

      <article>
        <p>With the introduction of Canvas, HTML5 has empower us to draw shapes, graphs, render texts, make gradients and patterns, manipulate images pixels, set an animations, even creating a stunning games!
All this stuffs occur on the client side in the browsers.
So let say you make an app that render some effects in a Canvas element and you want to allow user to take screenshot of the resut or save the result in your server for yourself.</p>

<p>Let’s digg how can we do it and save that canvas as an image in ther server using Rails.</p>

<h3 id="strategy-1--send-canvas-image-as-raw-dataurl">Strategy 1 : Send canvas image as raw dataURL</h3>

<p>The data URI scheme is a URI scheme that provides a way to include data in-line in web pages as if they were external resources. The <code class="highlighter-rouge">canvas.toDataURL()</code> method returns the image data of the canvas as Data URI. And the Data URI has the image data Encodes with MIME base64.</p>

<p>Let’s see how it works. Copy and run this javascript snippet in your browser console. Somewhere at the bottom of the page you’ll see a green circle.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'canvas'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">'2d'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">centerX</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">centerY</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>

	<span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">centerX</span><span class="p">,</span> <span class="nx">centerY</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">'green'</span><span class="p">;</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s1">'#003300'</span><span class="p">;</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>

	<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>

</code></pre></div></div>
<p>Now lets render that canvas as an image.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="kd">var</span> <span class="nx">dataURL</span> <span class="o">=</span>  <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s1">'image/png'</span><span class="p">);</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">dataURL</span><span class="p">;</span>

</code></pre></div></div>

<!--more-->

<p>As you can see, with that weird long url string something like <code class="highlighter-rouge">data:image/png;base64,iVBORw0KGgoA...</code>, it render a png image. That long url is infact data uri which has image data encoded with MIME base64.</p>

<p>The format to be specific is <em>** data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt; encoded data &gt; **</em>.</p>

<p>Now, if we want to save that image in the server, we can just send that data uri as normal params and at the server, we can use ruby to decode that save that data as image file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nb">require</span> <span class="s1">'base64'</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:data_uri</span><span class="p">]</span>
	<span class="sr">//</span> <span class="n">remove</span> <span class="n">all</span> <span class="n">extras</span> <span class="n">except</span> <span class="n">data</span>
    <span class="n">image_data</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">'data:image/png;base64,'</span><span class="p">.</span><span class="nf">length</span> <span class="o">..</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/public/uploads/somefilename.png"</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">write</span> <span class="n">image_data</span>
    <span class="k">end</span>

</code></pre></div></div>

<h3 id="strategy-2--send-it-as-a-blob-object">Strategy 2 : Send It as a Blob object</h3>

<p>This method also use the dataURL but instead of send it as a raw text, we convert it to an image file object and send it.
For this we use the Blob object. Simply it’s an object that represent a file-like object, so we create a blob object with the type PNG image, after we append this blob object to a FormData, and finally we send it through the jQuery Ajax Method.</p>

<p>Let’s detail a bit what I say above, we already see how we get the dataURL from an object, the dataURL is only a raw text, so we need to decode it to a binary data, we already know that the type of the encoding in the dataURL is Base64, and for decode it using a JavaScript solution we use the predefined atob method, now after decoding it we get a binary data, and we need to convert it to an array where there element is a 8-bit unsigned integer values. Finally we have to put this array in a new Uint8Array object for pass it to our Blob object that represent our file, now let create a function that do this and convert our Canvas to a blob object:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="c1">// Convert dataURL to Blob object</span>
	<span class="kd">function</span> <span class="nx">dataURLtoBlob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">)</span> <span class="p">{</span>
	  <span class="c1">// Decode the dataURL</span>
	  <span class="kd">var</span> <span class="nx">binary</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
	  <span class="c1">// Create 8-bit unsigned array</span>
	  <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[];</span>
	  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	      <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">binary</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
	  <span class="p">}</span>
	  <span class="c1">// Return our Blob object</span>
	  <span class="k">return</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">array</span><span class="p">)],</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'image/png'</span><span class="p">});</span>
	<span class="p">}</span>

</code></pre></div></div>

<p>We can now create a new FormData object, put our file on it and send our data using Ajax.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="c1">// Get our file</span>
	<span class="kd">var</span> <span class="nx">file</span><span class="o">=</span> <span class="nx">dataURLtoBlob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">);</span>
	<span class="c1">// Create new form data</span>
	<span class="kd">var</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
	<span class="c1">// Append our Canvas image file to the form data</span>
	<span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"image"</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
	<span class="c1">// And send it</span>
	<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
	   <span class="na">url</span><span class="p">:</span> <span class="s2">"/screenshot"</span><span class="p">,</span>
	   <span class="na">type</span><span class="p">:</span> <span class="s2">"POST"</span><span class="p">,</span>
	   <span class="na">data</span><span class="p">:</span> <span class="nx">fd</span><span class="p">,</span>
	   <span class="na">processData</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
	   <span class="na">contentType</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="p">});</span>

</code></pre></div></div>

<p>At controller:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/public/uploads/somefilename.png"</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:image</span><span class="p">].</span><span class="nf">read</span><span class="p">)</span>
    <span class="k">end</span>

</code></pre></div></div>

<p>So, that’s it.</p>

<p>This method is more appropriate and faster than the first one.</p>

<p>Those wondering how to mix this with carrierwave and paperclip, here are the links:</p>

<p><a href="http://stackoverflow.com/questions/14900038/rails-carrierwave-iphone-base64-image-upload">Rails carrierwave base-64 encoded image upload</a></p>

<p><a href="https://gist.github.com/WizardOfOgz/1012107">Base64-encoded images with Paperclip</a></p>

      <article>
      <div class="post-more">
        
        <a href="/2013/07/19/canvas-images-and-rails/#disqus_thread"> <i class="fa fa-comments" aria-hidden="true"></i>Comment</a>&nbsp;
        
        <a href="/2013/07/19/canvas-images-and-rails/"><i class="fa fa-plus-circle" aria-hidden="true"></i>Read more</a>
      </div>
    </div>
  
</div>
<hr />
<div class="pagination">
  
    <a href="/" class="previous">Previous</a>
  
  <span class="page_number ">Page: 2 of 4</span>
  
    <a href="/page3" class="next">Next</a>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
var foldableEvent = {
	'click' : function(target){
		if (target.className.indexOf('fold-by-click') == -1)
		{
			return;
		}

		var subMenu = target.parentElement.querySelectorAll('a.sidebar-nav-item-sub');
		if (subMenu.length < 1)
		{
			return;
		}

		var display = subMenu[0].style.display;
		subMenu.forEach(function(elem, index){
			elem.style.display = (display != 'none')? 'none' : '';
		});
	}
};

var activeEvent = {
	'click' : function(target){
		if (!target.classList.contains('sidebar-nav-item'))
		{
			return;
		}

		document.querySelectorAll('a.sidebar-nav-item').forEach(function(elem,index){
			elem.classList.remove('active');
		});

		target.classList.add('active');
	}
};

var context = decodeURIComponent(document.URL.replace(/^((http|https):\/\/[A-Za-z0-9.:]*\/)/g, '/')).replace(/\s/g, '-');

document.querySelectorAll('a.sidebar-nav-item').forEach(function(elem,index){
	var href = elem.getAttribute('href');
	var href1 = href.replace('/[a-zA-Z]/g','A');
	var categoryUrl = '/' + _page.category.toLowerCase();
	var menuUrl = _site.baseurl + _nav.Categories + '#' + _page.category.toLowerCase();
	if (context == href || (context != '/' && context.startsWith(categoryUrl) && menuUrl == href))
	{
		elem.classList.add('active');
	}
});

(function(document) {
	var toggle = document.querySelector('.sidebar-toggle');
	var sidebar = document.querySelector('#sidebar');
	var checkbox = document.querySelector('#sidebar-checkbox');

	document.addEventListener('click', function(e) {
	  var target = e.target;

	  if (target === toggle) {
		checkbox.checked = !checkbox.checked;
		e.preventDefault();
	  } else if (checkbox.checked && !sidebar.contains(target)) {
		checkbox.checked = false;
	  }

	  foldableEvent.click(target);
	  activeEvent.click(target);
	}, false);
})(document);

</script>


    
  </body>
  
  <script id="dsq-count-scr" src="//webdevelopmentlog.disqus.com/count.js" async></script>
  
  
</html>
