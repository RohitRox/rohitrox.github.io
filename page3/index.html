<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      RohitRox @ Tech &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Rohit Joshi's tech blog, tutorials and presentation slides</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about_me">About Me</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archives">Blog Archives</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories">Categories</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      This page is built using <a href="https://github.com/jekyll/jekyll" target="_blank">Jekyll</a>, <a href="https://github.com/poole/poole" target="_blank">Poole</a> and <a href="https://github.com/poole/lanyon" target="_blank">Lanyon</a>.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home" style="border: 2px solid #373737; padding: 2px 8px; color: #373737;">RohitRox @ Tech</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/08/18/lets-learn-to-knockout">
        Lets learn to knockout
      </a>
    </h1>

    <span class="post-date">18 Aug 2013</span>

    <p>Knockout.js is known for rapid and responsive UI development. Lets try it to build something today.
Lets see quick <a href="http://rohitrox.github.io/knockoutjs_projects">demo</a> of what we are going to build.</p>

<p><a href="https://github.com/RohitRox/knockoutjs_projects/archive/master.zip">Download Source</a></p>

<p>This is a basic table that is used in bills or receipts. We will try to add some magic to table like autocomplete, automatic information fill up of selected item and calculation of amounts with the help of knockout.</p>

<p>I will not describe what knockout.js is and why use it.
<a href="http://learn.knockoutjs.com">Learn.knockout.js</a> has an excellent
tutorial for knockout js beginners. I strongly suggest to go through
learn.knockoutjs.com before proceeding.</p>

<p>I assume basic understanding of knockout js from here.</p>

<p>Let’s setup the files first. Nothing fancy, I have just used jquery source file and knockout source js from their official websites and I have used twitter bootstrap prettifying stuffs.</p>

<p>I have initial table markup, which looks like as shown below:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span12"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;thead&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;th&gt;</span>Item<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>Description<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>Unit Price<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>Quantity<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>Amount<span class="nt">&lt;/th&gt;</span>
              <span class="nt">&lt;th&gt;</span>Actions<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/thead&gt;</span>
          <span class="nt">&lt;tbody&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span3"</span>  <span class="nt">/&gt;&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span4"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">class=</span><span class="s">"span1"</span> <span class="nt">/&gt;&lt;/td&gt;</span>
              <span class="nt">&lt;td&gt;&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Remove<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/tbody&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"pull-left"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Add New Row<span class="nt">&lt;/button&gt;</span>
          <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;strong&gt;</span>Grand Total: <span class="nt">&lt;span&gt;&lt;/span&gt;</span> <span class="nt">&lt;/strong&gt;</span>
        <span class="nt">&lt;/h4&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>
<p>Lets see what we have upto here and talk something about what we are trying to do to this table.</p>

<p><img src="/images/knockout-table-1.png" alt="knockout table 1" /></p>

<p>Lets summarize the behaviours we would like to have:</p>

<ul>
  <li>Add a new row</li>
  <li>Suggest items in item field</li>
  <li>Fill up the item information (description and price) automatically</li>
  <li>Calculate the grand total as items are added</li>
  <li>A remove button to remove item and re-compute grand total automatically on removal</li>
</ul>



    <a href="/2013/08/18/lets-learn-to-knockout">Read More...</a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/07/19/canvas-images-and-rails">
        Canvas Images and Rails
      </a>
    </h1>

    <span class="post-date">19 Jul 2013</span>

    <p>With the introduction of Canvas, HTML5 has empower us to draw shapes, graphs, render texts, make gradients and patterns, manipulate images pixels, set an animations, even creating a stunning games!
All this stuffs occur on the client side in the browsers.
So let say you make an app that render some effects in a Canvas element and you want to allow user to take screenshot of the resut or save the result in your server for yourself.</p>

<p>Let’s digg how can we do it and save that canvas as an image in ther server using Rails.</p>

<h3 id="strategy-1--send-canvas-image-as-raw-dataurl">Strategy 1 : Send canvas image as raw dataURL</h3>

<p>The data URI scheme is a URI scheme that provides a way to include data in-line in web pages as if they were external resources. The <code class="language-plaintext highlighter-rouge">canvas.toDataURL()</code> method returns the image data of the canvas as Data URI. And the Data URI has the image data Encodes with MIME base64.</p>

<p>Let’s see how it works. Copy and run this javascript snippet in your browser console. Somewhere at the bottom of the page you’ll see a green circle.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">canvas</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">centerX</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">centerY</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>

  <span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">centerX</span><span class="p">,</span> <span class="nx">centerY</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">green</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">#003300</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>

  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</code></pre></div></div>
<p>Now lets render that canvas as an image.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">dataURL</span> <span class="o">=</span>  <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">image/png</span><span class="dl">'</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">dataURL</span><span class="p">;</span>
</code></pre></div></div>

<!--more-->

<p>As you can see, with that weird long url string something like <code class="language-plaintext highlighter-rouge">data:image/png;base64,iVBORw0KGgoA...</code>, it render a png image. That long url is infact data uri which has image data encoded with MIME base64.</p>

<p>The format to be specific is <em>** data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt; encoded data &gt; **</em>.</p>

<p>Now, if we want to save that image in the server, we can just send that data uri as normal params and at the server, we can use ruby to decode that save that data as image file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">require</span> <span class="s1">'base64'</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:data_uri</span><span class="p">]</span>
  <span class="c1"># remove all extras except data</span>
  <span class="n">image_data</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">'data:image/png;base64,'</span><span class="p">.</span><span class="nf">length</span> <span class="o">..</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/public/uploads/somefilename.png"</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
    <span class="n">f</span><span class="p">.</span><span class="nf">write</span> <span class="n">image_data</span>
  <span class="k">end</span>
</code></pre></div></div>

<h3 id="strategy-2--send-it-as-a-blob-object">Strategy 2 : Send It as a Blob object</h3>

<p>This method also use the dataURL but instead of send it as a raw text, we convert it to an image file object and send it.
For this we use the Blob object. Simply it’s an object that represent a file-like object, so we create a blob object with the type PNG image, after we append this blob object to a FormData, and finally we send it through the jQuery Ajax Method.</p>

<p>Let’s detail a bit what I say above, we already see how we get the dataURL from an object, the dataURL is only a raw text, so we need to decode it to a binary data, we already know that the type of the encoding in the dataURL is Base64, and for decode it using a JavaScript solution we use the predefined atob method, now after decoding it we get a binary data, and we need to convert it to an array where there element is a 8-bit unsigned integer values. Finally we have to put this array in a new Uint8Array object for pass it to our Blob object that represent our file, now let create a function that do this and convert our Canvas to a blob object:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Convert dataURL to Blob object</span>
  <span class="kd">function</span> <span class="nx">dataURLtoBlob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Decode the dataURL</span>
    <span class="kd">var</span> <span class="nx">binary</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="c1">// Create 8-bit unsigned array</span>
    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">binary</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">// Return our Blob object</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">array</span><span class="p">)],</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">image/png</span><span class="dl">'</span><span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>We can now create a new FormData object, put our file on it and send our data using Ajax.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Get our file</span>
  <span class="kd">var</span> <span class="nx">file</span><span class="o">=</span> <span class="nx">dataURLtoBlob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">);</span>
  <span class="c1">// Create new form data</span>
  <span class="kd">var</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
  <span class="c1">// Append our Canvas image file to the form data</span>
  <span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">image</span><span class="dl">"</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
  <span class="c1">// And send it</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
     <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/screenshot</span><span class="dl">"</span><span class="p">,</span>
     <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
     <span class="na">data</span><span class="p">:</span> <span class="nx">fd</span><span class="p">,</span>
     <span class="na">processData</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="na">contentType</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>At controller:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/public/uploads/somefilename.png"</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
    <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:image</span><span class="p">].</span><span class="nf">read</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>So, that’s it.</p>

<p>This method is more appropriate and faster than the first one.</p>

<p>Those wondering how to mix this with carrierwave and paperclip, here are the links:</p>

<p><a href="http://stackoverflow.com/questions/14900038/rails-carrierwave-iphone-base64-image-upload">Rails carrierwave base-64 encoded image upload</a></p>

<p><a href="https://gist.github.com/WizardOfOgz/1012107">Base64-encoded images with Paperclip</a></p>


    <a href="/2013/07/19/canvas-images-and-rails">Read More...</a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/07/02/ruby-dynamic-methods">
        Ruby Dynamic Methods
      </a>
    </h1>

    <span class="post-date">02 Jul 2013</span>

    <p>We define methods using <strong><em>def</em></strong> keywords which is fine for most of the cases.</p>

<p>But consider a situation where you have to create a series of methods all of which have the same basic structure and logic then it seems repititive and not dry.</p>

<p>Ruby, being a dynamic language, you can create methods on the fly.</p>

<p>So, what does that mean?</p>

<p>lets see this simplest example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">class</span> <span class="nc">A</span>
    <span class="n">define_method</span> <span class="ss">:a</span> <span class="k">do</span>
      <span class="nb">puts</span> <span class="s2">"hello"</span>
    <span class="k">end</span>

    <span class="n">define_method</span> <span class="ss">:greeting</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
      <span class="nb">puts</span> <span class="n">message</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">A</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">a</span> <span class="c1">#=&gt; hello</span>
  <span class="no">A</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">greeting</span> <span class="s1">'Ram ram'</span> <span class="c1">#=&gt; Ram ram</span>

</code></pre></div></div>

<!--more-->

<p>The <strong><em>define_method</em></strong> defines an instance method in the receiver. The syntax and usage are self-explained in the example above.</p>

<p>lets see following example that may be useful in practical scenarios.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">class</span> <span class="nc">User</span>

    <span class="no">ACTIVE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="no">INACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="no">PENDING</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nb">attr_accessor</span> <span class="ss">:status</span>

    <span class="k">def</span> <span class="nf">active?</span>
      <span class="n">status</span> <span class="o">==</span> <span class="no">ACTIVE</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">inactive?</span>
      <span class="n">status</span> <span class="o">==</span> <span class="no">User</span><span class="o">::</span><span class="no">INACTIVE</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">pending?</span>
      <span class="n">status</span> <span class="o">==</span> <span class="no">User</span><span class="o">::</span><span class="no">PENDING</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="n">user</span><span class="p">.</span><span class="nf">inactive?</span>
  <span class="c1">#=&gt; true</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">active?</span>
  <span class="c1">#=&gt; false</span>

</code></pre></div></div>

<p>Refactored code using dynamic method definition:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">class</span> <span class="nc">User</span>

    <span class="no">ACTIVE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="no">INACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="no">PENDING</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nb">attr_accessor</span> <span class="ss">:status</span>

    <span class="p">[</span><span class="ss">:active</span><span class="p">,</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="ss">:pending</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
      <span class="n">define_method</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2">?"</span> <span class="k">do</span>
        <span class="n">status</span> <span class="o">==</span> <span class="no">User</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="nb">method</span><span class="p">.</span><span class="nf">upcase</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="n">user</span><span class="p">.</span><span class="nf">inactive?</span>
  <span class="c1">#=&gt; true</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">active?</span>
  <span class="c1">#=&gt; false</span>

</code></pre></div></div>
<p>We use define_method to define method dynamically.</p>

<p>We can also define instance methods with a class method, using this technique we can expose a class method that will generate the  instance methods. COOL !</p>

<p>Example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">User</span>

    <span class="no">ACTIVE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="no">INACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="no">PENDING</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nb">attr_accessor</span> <span class="ss">:status</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">states</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">args</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
        <span class="n">define_method</span> <span class="s2">"</span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">?"</span> <span class="k">do</span>
          <span class="nb">self</span><span class="p">.</span><span class="nf">status</span> <span class="o">==</span> <span class="no">User</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="nf">upcase</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">states</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="ss">:pending</span>
  <span class="k">end</span>


</code></pre></div></div>

<p>Now, what about class methods. The simplest way is</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">class</span> <span class="nc">A</span>
      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
        <span class="n">define_method</span> <span class="n">method_name</span> <span class="k">do</span>
          <span class="c1">#...</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

</code></pre></div></div>
<p>There are <strong><em>instance_eval</em></strong> and <strong><em>class_eval</em></strong> also, which are used for dynamic method definition. These methods allow you to evaluate arbitrary code in the context of a particular class or object. These methods can be very confusing sometimes. You can read <a href="http://stackoverflow.com/questions/900419/how-to-understand-the-difference-between-class-eval-and-instance-eval">this</a> discussion and <a href="http://www.ploughthroughruby.co.uk/2009/09/30/define_method-instance_eval-and-class_eval.html/">this</a> blog post and understand how they can be used.</p>

<p>From that discussion, we summerize</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">Foo</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">class_bar</span>
      <span class="s2">"class_bar"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">instance_bar</span>
      <span class="s2">"instance_bar"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">class_bar</span>       <span class="c1">#=&gt; undefined method ‘class_bar’ for Foo:Class</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">class_bar</span>   <span class="c1">#=&gt; "class_bar"</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">instance_bar</span>       <span class="c1">#=&gt; "instance_bar"</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">instance_bar</span>   <span class="c1">#=&gt; undefined method ‘instance_bar’ for #&lt;Foo:0x7dce8&gt;</span>
</code></pre></div></div>

<p>Note that, we don’t use <strong><em>define_method</em></strong> inside *_eval, becasue it does not matter if you use define_method inside class_eval or instance_eval it would always create an instance method.</p>

<p>And, we get this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">Foo</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>

  <span class="no">Foo</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>
    <span class="n">define_method</span> <span class="s2">"class_bar"</span> <span class="k">do</span>
      <span class="s2">"class_bar"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">Foo</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
    <span class="n">define_method</span> <span class="s2">"instance_bar"</span> <span class="k">do</span>
      <span class="s2">"instance_bar"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">Foo</span><span class="p">.</span><span class="nf">class_bar</span> <span class="c1">#=&gt; undefined</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">class_bar</span> <span class="c1">#=&gt; "class_bar"</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">instance_bar</span> <span class="c1">#=&gt; undefined</span>
  <span class="no">Foo</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">instance_bar</span> <span class="c1">#=&gt; "instance_bar"</span>

</code></pre></div></div>

<p>Next, we can invoke methods dynamically. One way to invoke a method dynamically in ruby is to send a message to the object. We can send a message to a class either within the class definition itself, or by simply sending it to the class object like you’d send any other message. This can be accomplished by usin <strong><em>send</em></strong>.</p>

<p>The simplest example could be:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="n">s</span><span class="o">=</span> <span class="s2">"hi man"</span>

  <span class="nb">p</span> <span class="n">s</span><span class="p">.</span><span class="nf">length</span> <span class="c1">#=&gt; 6</span>
  <span class="nb">p</span> <span class="n">s</span><span class="p">.</span><span class="nf">include?</span> <span class="s2">"hi"</span> <span class="c1">#=&gt; true</span>

  <span class="nb">p</span> <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:length</span><span class="p">)</span> <span class="c1">#=&gt; 6</span>
  <span class="nb">p</span> <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:include?</span><span class="p">,</span><span class="s2">"hi"</span><span class="p">)</span> <span class="c1">#=&gt; true</span>

</code></pre></div></div>

<p>How can this be ever useful?</p>

<p>Lets see the following code( example taken from <a href="http://www.funonrails.com/2011/12/dynamic-methods-inside-ruby-classes.html">here</a>)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">protect_from_forgery</span>
    <span class="n">helper_method</span> <span class="ss">:current_staff</span><span class="p">,</span> <span class="ss">:current_employee</span><span class="p">,</span> <span class="n">current_admin</span>

    <span class="k">def</span> <span class="nf">authenticate_staff!</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
      <span class="n">current_staff</span> <span class="o">||</span> <span class="n">not_authorized</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_staff</span>
      <span class="n">current_user</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Staff</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">authenticate_employee!</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
      <span class="n">current_employee</span> <span class="o">||</span> <span class="n">not_authorized</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_employee</span>
      <span class="n">current_user</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Employee</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">authenticate_admin!</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
      <span class="n">current_admin</span> <span class="o">||</span> <span class="n">not_authorized</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_admin</span>
      <span class="n">current_user</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Admin</span>
    <span class="k">end</span>
  <span class="k">end</span>

</code></pre></div></div>

<p>And refactored one:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="sx">%w(Staff Employee Admin)</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
    <span class="n">define_method</span> <span class="s2">"current_</span><span class="si">#{</span><span class="n">k</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="nf">constantize</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">define_method</span> <span class="s2">"authenticate_</span><span class="si">#{</span><span class="n">k</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">!"</span> <span class="k">do</span> <span class="o">|</span><span class="n">opts</span><span class="o">=</span><span class="p">{}</span><span class="o">|</span>
      <span class="nb">send</span><span class="p">(</span><span class="s2">"current_</span><span class="si">#{</span><span class="n">k</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="o">||</span> <span class="n">not_authorized</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Dynamically defined methods can help guard against method definition mistakes, avoid repetitive codes and be concise and smart.</p>

<p>Happy Metaprogramming.</p>


    <a href="/2013/07/02/ruby-dynamic-methods">Read More...</a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/05/23/jquery-performance-tuning">
        Jquery Performance Tuning
      </a>
    </h1>

    <span class="post-date">23 May 2013</span>

    <p>After searching and digging a lot of artciles about improving jquery performance in web apps, I decided to make a list of best common performance tips and bect practices. We’ll also reveal some of JQuery’s hidden feature and how we can use them for performance tuning.</p>

<p>Lets divide this post into 4 main categoris.</p>

<ul>
  <li>Selector Performace</li>
  <li>DOM Manipulation</li>
  <li>Events</li>
  <li>Digging into JQuery Secrets</li>
  <li>General and All-Time performance tricks</li>
</ul>

<!--more-->

<h2 id="selector-performace">Selector Performace</h2>

<h4 id="know-your-selectors">Know your selectors</h4>

<p>You should be careful about using jquery selectors because all selectors are nor created equally. With benchmarks, we can see:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#id, element</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Id and Element selectors are the fastest</span>
  <span class="c1">// the reason is because it maps to a native JavaScript methods</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.class_name</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Slower class selectors</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">:hidden, [attribute=value]</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Pseudo and Attribute selectors are the slowest</span>

</code></pre></div></div>

<h4 id="optimize-selectors-for-sizzles-right-to-left-model">Optimize selectors for Sizzle’s ‘right to left’ model</h4>

<p>JQuery as of now uses the Sizzle Javascript Selector Library which works a bit differently from the selector engine used in the past versions. Namely it uses a ‘right to left’ model rather than a ‘left to right’. Make sure that your right-most selector is really specific and any selectors on the left are more broad:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">linkContacts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.contact-links div.side-wrapper</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Good</span>
  <span class="kd">var</span> <span class="nx">linkContacts</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">a.contact-links .side-wrapper</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Bad</span>

</code></pre></div></div>

<h4 id="keep-it-simple">Keep it Simple!</h4>

<p>Avoid overly complex selectors. Unless you have an incredibly complex HTML document, it’s rare you’ll need any more than two or three qualifiers.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">body #page:first-child article.main p#intro em</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Bad</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">p#intro em</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Good</span>

</code></pre></div></div>

<h4 id="class-selectors-and-context">Class selectors and Context</h4>

<p>Always try to scope your selectors with id or element.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.active</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span> <span class="c1">// bad</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#header .active</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span> <span class="c1">// better</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.active</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">#header</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span> <span class="c1">// better</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#header</span><span class="dl">'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">.active</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span> <span class="c1">// fastest</span>
  <span class="c1">// .find() is faster because it directly uses native javascript methods to search inside the passsed context under the hood</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">button.active</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// fastest</span>
  <span class="c1">// grabs all matches tags FIRST, then iterates through them to find matching classes</span>
</code></pre></div></div>

<h2 id="dom-manipulation">DOM Manipulation</h2>

<h4 id="cache-and-chains-to-avoid-reselection">Cache and Chains to Avoid Reselection</h4>

<p>Interacting with the DOM as little as possible will drastically speed up your applications.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Bad</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#sidebar .promo</span><span class="dl">'</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#sidebar .newPromo</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#sidebar</span><span class="dl">'</span><span class="p">).</span><span class="nx">after</span><span class="p">(</span><span class="nx">somethingcool</span><span class="p">);</span>

  <span class="c1">// Good</span>
  <span class="kd">var</span> <span class="nx">sb</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#sidebar</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">sb</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">.promo</span><span class="dl">'</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
  <span class="nx">sb</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">.newPromo</span><span class="dl">'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
  <span class="nx">sb</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">somethingcool</span><span class="p">);</span>

  <span class="c1">// Bad</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">p</span><span class="dl">"</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="dl">"</span><span class="s2">color</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">p</span><span class="dl">"</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="dl">"</span><span class="s2">font-size</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">1.2em</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">p</span><span class="dl">"</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">Text changed!</span><span class="dl">"</span><span class="p">);</span>

  <span class="c1">// Good</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">p</span><span class="dl">"</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span> <span class="dl">"</span><span class="s2">color</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">font-size</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.2em</span><span class="dl">"</span><span class="p">}).</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">Text changed!</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="wrap-everything-in-a-single-element-when-doing-any-kind-of-dom-insertion">Wrap everything in a single element when doing any kind of DOM insertion</h4>

<p>DOM manipulation is very slow. Try to modify your HTML structure as little as possible.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">menu</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&lt;ul id="menu"&gt;</span><span class="dl">'</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">menu</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;li&gt;</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;/li&gt;</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">menu</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1">&lt;/ul&gt;</span><span class="dl">'</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#header</span><span class="dl">'</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">menu</span><span class="p">);</span>

  <span class="c1">// Instead of doing:</span>

  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#header</span><span class="dl">'</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;ul id="menu"&gt;&lt;/ul&gt;</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#menu</span><span class="dl">'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;li&gt;</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;/li&gt;</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h2 id="events">Events</h2>

<h4 id="leverage-event-delegation">Leverage Event Delegation</h4>

<p>Event listeners cost memory. In complex websites and apps it’s not uncommon to have a lot of event listeners floating around, and thankfully jQuery provides some really easy methods for handling event listeners efficiently through delegation.</p>

<p>When you have a lot of elements in a container and you want to assign an event to all of them – use delegation to handle it. Delegation provides you with the ability to bind only one event to a parent element and then check on what child the event acted (target). It’s very handy when you have a big table with a lot of data and you want to set events to the TDs. Grab the table, set the delegation event for all the TDs:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">table</span><span class="dl">"</span><span class="p">).</span><span class="nx">delegate</span><span class="p">(</span><span class="dl">"</span><span class="s2">td</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hover</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">hover</span><span class="dl">"</span><span class="p">);</span>

  <span class="p">});</span>

</code></pre></div></div>

<h2 id="digging-into-jquery-secrets">Digging into JQuery Secrets</h2>

<h4 id="element-creation">Element Creation</h4>

<p>The following snippet is enough what I mean:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="kd">var</span> <span class="nx">myDiv</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;div/&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-new-element</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">class</span><span class="p">:</span> <span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">css</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">color</span><span class="p">:</span> <span class="dl">'</span><span class="s1">red</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">backgrondColor</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#FFF</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">border</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1px solid #CCC</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">click</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Clicked!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">html</span><span class="p">:</span> <span class="nx">jQuery</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;a/&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">href</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">click</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// do something</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">});</span>

</code></pre></div></div>

<h4 id="writing-own-selectors">Writing own selectors</h4>

<p>If you have selectors that you use often in your script – extend jQuery object $.expr[’:’] and write your own selector.
In the following example We create a selector above_the_fold that returns a set of elements that are not visible:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">expr</span><span class="p">[</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">],</span> <span class="p">{</span>
    <span class="na">above_the_fold</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">&lt;</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">nonVisibleElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">div:above_the_fold</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Select the elements</span>

</code></pre></div></div>

<h4 id="css-hooks">CSS Hooks</h4>

<p>The <a href="http://api.jquery.com/jQuery.cssHooks/">CSS hooks API</a> was introduced to give developers the ability to get and set particular CSS values. Using it, you can hide browser specific implementations and expose a unified interface for accessing particular properties.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="nx">$</span><span class="p">.</span><span class="nx">cssHooks</span><span class="p">[</span><span class="dl">'</span><span class="s1">borderRadius</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">get</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">computed</span><span class="p">,</span> <span class="nx">extra</span><span class="p">){</span>
      <span class="c1">// Depending on the browser, read the value of</span>
      <span class="c1">// -moz-border-radius, -webkit-border-radius or border-radius</span>
    <span class="p">},</span>
    <span class="na">set</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
      <span class="c1">// Set the appropriate CSS3 property</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">// Use it without worrying which property the browser actually understands:</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#rect</span><span class="dl">'</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">borderRadius</span><span class="dl">'</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>

</code></pre></div></div>

<p>What is even better, is that people have already built a rich <a href="https://github.com/brandonaaron/jquery-cssHooks">library of supported CSS hooks</a> that you can use for free in your next project.</p>

<h2 id="general-and-all-time-tricks">General And All time tricks</h2>

<!--more-->

<h4 id="use-html5">Use HTML5</h4>

<p>You may wonder how jquery performance and HTML5 are related but the new HTML 5 standard comes with new tags and a lighter DOM structure in mind. Lighter DOM structure and different tags diferent purpose for means less elements to traverse for jQuery.</p>

<h4 id="dom-isnt-your-database">DOM isn’t your database</h4>

<p>Traversing DOM to retrieve information stored in .text(), .html() is not optimal approach. Use html5 data to attach any kind of information in DOM. With the recent updates to the jQuery data() method, HTML5 data attributes are pulled automatically and are available as entries.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"d1"</span> <span class="na">data-role=</span><span class="s">"page"</span> <span class="na">data-page_hash=</span><span class="s">"H4jk8s00"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#d1</span><span class="dl">"</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">);</span> <span class="c1">//page</span>
  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#d1</span><span class="dl">"</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="dl">"</span><span class="s2">page_hash</span><span class="dl">"</span><span class="p">);</span> <span class="c1">//H4jk8s00</span>
</code></pre></div></div>

<h4 id="append-style-tag-when-styling-15-or-more-elements">Append style tag when styling 15 or more elements</h4>

<p>When styling a few elements it is best to simply use jQuery’s css() method, however when styling 15 or more elements it is more efficient to append a style tag to the DOM instead of applying css to each items.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;style type="text/css"&gt; div.activated { color: red; } &lt;/style&gt;</span><span class="dl">'</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">);</span>

</code></pre></div></div>

<h5 id="always-use-the-latest-version">Always use the latest version</h5>

<p>JQuery is always in constant development and improvement. The latest version always contains more bug fixes and performance improvements so it is always wise to keep upto date with the latest versions.</p>

<h4 id="combine-jquery-with-raw-javascript-where-needed">Combine jQuery with raw Javascript where needed</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#someAnchor</span><span class="dl">'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#someAnchor</span><span class="dl">'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span>
  <span class="p">});</span>

</code></pre></div></div>

<h4 id="load-the-framework-from-google-code">Load the framework from Google Code</h4>

<p>I urge everyone to use the Google AJAX Libraries content delivery network to serve jQuery to users directly from Google’s network of datacenters. Doing so has several advantages over hosting jQuery on your server(s): decreased latency, increased parallelism, and better caching.</p>

<p>The only disadvantage is that if the connection to the CDN were to fail, our site would be left with no jQuery library which could be a big deal if we run a jQuery intensive website. If it happens then there should be some mechanism to fetch the library from other source or from our own locally hosted location. Fortunately, you can easily reference a backup. You can have a copy of jQuery on your server, and use a little bit of JavaScript to load it only if the Google one doesn’t load for some reason.
This little snippet, found in HTML5 Boilerplate, will do just that:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;script src="js/libs/jquery-1.9.0.min.js"&gt;&lt;</span><span class="se">\</span><span class="s1">/script&gt;</span><span class="dl">'</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>


    <a href="/2013/05/23/jquery-performance-tuning">Read More...</a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/03/18/feature-flippers-with-rollout">
        Feature flippers with rollout
      </a>
    </h1>

    <span class="post-date">18 Mar 2013</span>

    <p>Rollout gem comes handy when we need deploy a beta feature, may be to a selected group of users or some percentage of uses so that few users can try it out before it goes massive.</p>

<p>So lets rollout.</p>

<p>We’ll be using redis as rollout’s backend.</p>

<p>To setup, jusst add <code class="language-plaintext highlighter-rouge">gem 'rollout'</code> to Gemfile and run <code class="language-plaintext highlighter-rouge">bundle install</code>.</p>

<p>Now, we need to create a rollout setup file inside initializer.</p>

<p>Let’s name it rollout_init.rb which looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="vg">$redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="p">.</span><span class="nf">new</span>
  <span class="vg">$rollout</span> <span class="o">=</span> <span class="no">Rollout</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vg">$redis</span><span class="p">)</span>
  <span class="vg">$rollout</span><span class="p">.</span><span class="nf">define_group</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">admin?</span>
  <span class="k">end</span>

</code></pre></div></div>
<p>Documentation suggests to use a global variables. So we create one with a new redis instance.
Then, we create rollout instance passsing that redis instance. We can configure rollout in many ways, here we are defining an admin group by passing a block and checking whether the user belongs to that group or not.
Complete documentation can be found <a href="https://github.com/jamesgolick/rollout">here</a>.</p>

<p>Next, we can now use handy rollout method like for example let’s say we need to activate chat feature for admin group only.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">if</span> <span class="vg">$rollout</span><span class="p">.</span><span class="nf">active?</span> <span class="ss">:chat</span><span class="p">,</span> <span class="n">current_user</span>

    <span class="o">...</span><span class="p">.</span>

  <span class="nf">end</span>

</code></pre></div></div>

<!--more-->

<p>The <code class="language-plaintext highlighter-rouge">$rollout.active?</code> method accepts the name of the feature and the user and returns true or false.</p>

<p>This method is accessible in views as well as in controllers.
That’s not all, if you restart your server now and look at the app, you may find out that the feature is unavailable to admin groups also, it is because by default the feature is deactivated to all groups or users. We can make a rake task or an interface for activating the feature to subset of users. Activating code looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="vg">$rollout</span><span class="p">.</span><span class="nf">activate_group</span><span class="p">(</span><span class="ss">:chat</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>

</code></pre></div></div>
<p>This will activate the feature ( chat in our case ) for admin group.</p>

<p>Also we can activate the feature to all users or specific user or to some percentage.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="vg">$rollout</span><span class="p">.</span><span class="nf">activate_group</span><span class="p">(</span> <span class="ss">:chat</span><span class="p">,</span> <span class="ss">:all</span> <span class="p">)</span> <span class="c1">#activate to all, there is all group already by default</span>

  <span class="vg">$rollout</span><span class="p">.</span><span class="nf">activate_user</span><span class="p">(</span> <span class="ss">:chat</span><span class="p">,</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="s2">"admin@myapp.com"</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#activate to specific user</span>

  <span class="vg">$rollout</span><span class="p">.</span><span class="nf">activate_percantage</span><span class="p">(</span> <span class="ss">:chat</span><span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="c1">#activate to 50% of users</span>

</code></pre></div></div>

<p>Each of these methods have deactivate version for deactivating the feature. You can also just call <code class="language-plaintext highlighter-rouge">$rollout.deactivate_all(:chat)</code> to deactivate the feature to all at once.</p>


    <a href="/2013/03/18/feature-flippers-with-rollout">Read More...</a>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page2">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
